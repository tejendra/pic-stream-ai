runtime: nodejs20
# entrypoint: node backend/src/server.js
entrypoint: node -e "console.log('âœ… using apphosting.yaml entrypoint')"

# Settings for Backend (on Cloud Run).
# See https://firebase.google.com/docs/app-hosting/configure#cloud-run
# bundles:
  # - name: frontend
  #   dir: backend/public
    # command: |
    #   cd frontend
    #   npm ci
    #   npm run build
    #   rm -rf ../backend/public
    #   mkdir -p ../backend/public
    #   cp -r build/* ../backend/public/
  #   include: "**/*"
scripts:
    buildCommand: |
      cd frontend
      npm ci
      npm run build
      rm -rf ../backend/public
      mkdir -p ../backend/public
      cp -r build/* ../backend/public/
    runCommand: |
      cd backend
      npm start

handlers:
  # Serve static assets (JS, CSS, images, etc.)
  - url: /(.*\.(css|js|png|jpg|jpeg|gif|svg|ico|json|txt|woff|woff2|ttf|eot|otf|map))
    static_files: backend/public/\1
    upload: backend/public/(.*)

  # SPA fallback to index.html
  - url: /.*
    static_files: backend/public/index.html
    upload: backend/public/index.html

runConfig:
  minInstances: 0
  # maxInstances: 100
  # concurrency: 80
  # cpu: 1
  # memoryMiB: 512

# Environment variables and secrets.
env:
  # Configure environment variables.
  # See https://firebase.google.com/docs/app-hosting/configure#user-defined-environment
  - variable: NODE_ENV
    value: "production"
    availability:
      - BUILD
      - RUNTIME
  - variable: FRONTEND_URL
    value: "https://pic-stream-ai-backend--pic-stream-ai.us-central1.hosted.app"
    availability:
      - BUILD
      - RUNTIME


  # Grant access to secrets in Cloud Secret Manager.
  # See https://firebase.google.com/docs/app-hosting/configure#secret-parameters
  # - variable: MY_SECRET
  #   secret: mySecretRef
